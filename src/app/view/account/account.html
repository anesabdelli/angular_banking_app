<div class="account-root">
  <h2>Mon espace compte</h2>

  <div class="container mt-4">
    <!-- En-tête -->
    <div class="row mb-4">
      <div class="col-12">
        <h2 class="text-center mb-3">Mon espace compte</h2>
        <div class="alert alert-info text-center" *ngIf="user">
          Bienvenue, <strong>{{ user.name }}</strong>
        </div>
      </div>
    </div>

    <!-- Messages d'erreur et chargement -->
    <div class="row" *ngIf="error()">
      <div class="col-12">
        <div class="alert alert-danger" role="alert">{{ error() }}</div>
      </div>
    </div>
    <div class="row" *ngIf="loading()">
      <div class="col-12">
        <div class="alert alert-warning" role="alert">Chargement...</div>
      </div>
    </div>

    <!-- Comptes -->
    <div *ngIf="!loading() && accounts().length > 0; else noAccounts">

      <!-- Sélecteur de compte -->
      <div class="row mb-4">
        <div class="col-12 col-md-8 offset-md-2">
          <div class="card shadow-sm">
            <div class="card-body">
              <label for="accountSelect" class="form-label">Choisir un compte :</label>
              <select id="accountSelect" class="form-select" (change)="onAccountChange($event)">
                <option *ngFor="let acc of accounts()"
                        [value]="acc.id"
                        [selected]="account() && account()!.id === acc.id">
                  {{ acc.label || acc.id }} — {{ acc.balance | currency:'EUR':'symbol':'1.2-2' }}
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Détails du compte -->
      <div class="row mb-4" *ngIf="account()">
        <div class="col-12 col-md-8 offset-md-2">
          <div class="card shadow">
            <div class="card-body">
              <h3 class="card-title">{{ account()!.label || 'Compte ' + account()!.id }}</h3>
              <p class="mb-2"><strong>Solde :</strong> <span class="text-success fs-5">{{ account()!.balance | currency:'EUR':'symbol':'1.2-2' }}</span></p>

              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary" (click)="onInfosClick()">Infos</button>
                <button class="btn btn-primary" (click)="onSendClick()">Envoyer</button>
                <button class="btn btn-outline-secondary" (click)="onOpenClick()">Ouvrir un nouveau compte</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Infos supplémentaires du compte (affiché quand on clique sur Infos) -->
      <div *ngIf="showAccountInfo() && account()" class="row mb-4">
        <div class="col-12 col-md-8 offset-md-2">
          <div class="card shadow border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Informations détaillées</h5>
              <button type="button" class="btn-close btn-close-white" (click)="toggleAccountInfo()"></button>
            </div>
            <div class="card-body">
              <p><strong>ID du compte :</strong> {{ account()!.id }}</p>
              <p><strong>Libellé :</strong> {{ account()!.label || '(non défini)' }}</p>
              <p><strong>Solde actuel :</strong> <span class="fw-bold text-success">{{ account()!.balance | currency:'EUR':'symbol':'1.2-2' }}</span></p>
              <p><strong>Ouvert le :</strong> {{ account()!.openAt | date:'dd/MM/yyyy à HH:mm' }}</p>
              <p><strong>Propriétaire :</strong> {{ user?.name || 'Vous' }}</p>
            </div>
            <div class="card-footer text-center">
              <button class="btn btn-outline-primary btn-sm" (click)="toggleAccountInfo()">Fermer</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SECTION TRANSACTIONS -->
      <div class="row mb-4" *ngIf="account()">
        <div class="col-12 col-md-8 offset-md-2">
          <div class="card shadow">
            <div class="card-body">
              <h3 class="card-title">Historique des transactions</h3>

              <div *ngIf="transactionsLoading()" class="alert alert-warning">Chargement des transactions...</div>
              <div *ngIf="transactionsError()" class="alert alert-danger">{{ transactionsError() }}</div>
              <div *ngIf="!transactionsLoading() && transactions().length === 0 && !transactionsError()">
                Aucune transaction pour ce compte.
              </div>

              <div *ngIf="transactions().length > 0" class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Date</th>
                      <th>Description</th>
                      <th>Montant</th>
                      <th>Type</th>
                      <th>Autre partie</th>
                      <th *ngIf="hasAnyCancellable()">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let tx of transactions()" class="transaction-row"
                        (click)="goToTransactionDetail(tx.id)" style="cursor: pointer;">
                      <td>{{ tx.formattedDate ?? (tx.emittedAt | date:'dd/MM/yyyy HH:mm') }}</td>
                      <td>{{ tx.description || '(sans description)' }}</td>

                      <!-- Montant barré si annulé + statut simple -->
                      <td [class.text-danger]="(tx.displayAmount ?? tx.amount) < 0"
                          [class.text-success]="(tx.displayAmount ?? tx.amount) > 0"
                          class="fw-bold">
                        <span [class.text-muted]="tx.status === 'cancelled'" 
                              [class.text-decoration-line-through]="tx.status === 'cancelled'">
                          {{ (tx.displayAmount ?? tx.amount) | currency:'EUR':'symbol':'1.2-2' }}
                        </span>
                        <br>
                        <small class="text-muted">
                          {{ tx.status | titlecase }}
                        </small>
                      </td>

                      <td>
                        <span class="badge"
                              [class.bg-danger]="(tx.displayAmount ?? tx.amount) < 0"
                              [class.bg-success]="(tx.displayAmount ?? tx.amount) > 0">
                          {{ (tx.displayAmount ?? tx.amount) < 0 ? 'Débit' : 'Crédit' }}
                        </span>
                      </td>
                      <td>{{ tx.otherParty ?? '' }}</td>

                      <!-- Bouton Annuler avec countdown -->
                      <td *ngIf="hasAnyCancellable()">
                        <button 
                          *ngIf="isCancellable(tx)"
                          class="btn btn-sm btn-danger"
                          (click)="cancelPendingTransaction(tx.id); $event.stopPropagation()">
                          Annuler ({{ getCountdown(tx.id) }}s)
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- fin *ngIf comptes -->

    <!-- Template aucun compte -->
    <ng-template #noAccounts>
      <div class="row">
        <div class="col-12 col-md-6 offset-md-3">
          <div class="card shadow text-center">
            <div class="card-body py-5">
              <p>Aucun compte trouvé pour cet utilisateur.</p>
              <button class="btn btn-primary" (click)="onOpenClick()">Ouvrir un premier compte</button>
            </div>
          </div>
        </div>
      </div>
    </ng-template>

  </div> <!-- container -->
</div> <!-- account-root -->